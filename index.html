<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIU Calculator - Speech Analysis Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #1A1A1A;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            min-height: 100vh;
        }

        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E8E8E8;
            padding: 30px 60px;
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            margin: 0;
            color: #1A1A1A;
            font-weight: 500;
            letter-spacing: -0.3px;
        }

        .content {
            padding: 80px 60px 120px;
            background: white;
            max-width: 900px;
            margin: 0 auto;
        }

        .section {
            margin-bottom: 80px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 500;
            color: #666666;
            margin-bottom: 20px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .step-number {
            display: none;
        }

        .recording-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid #1A1A1A;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #FFFFFF;
            color: #1A1A1A;
            letter-spacing: -0.2px;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .btn-record {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #1A1A1A;
        }

        .btn-record:hover:not(:disabled) {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .btn-record.recording {
            background: #1A1A1A;
            color: #FFFFFF;
            animation: none;
        }

        .btn-stop {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #1A1A1A;
        }

        .btn-stop:hover:not(:disabled) {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .btn-analyze {
            background: #FFFFFF;
            color: #1A1A1A;
            border: 1px solid #1A1A1A;
        }

        .btn-analyze:hover:not(:disabled) {
            background: #1A1A1A;
            color: #FFFFFF;
        }

        .timer {
            padding: 12px 24px;
            background: #FAFAFA;
            border: 1px solid #E8E8E8;
            border-radius: 24px;
            font-size: 24px;
            font-weight: 300;
            color: #1A1A1A;
            font-variant-numeric: tabular-nums;
            min-width: 120px;
            text-align: center;
            letter-spacing: 1px;
        }

        .timer.recording {
            background: #F5F5F5;
            border-color: #1A1A1A;
            color: #1A1A1A;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 1px solid #E8E8E8;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            background: #FAFAFA;
        }

        textarea:focus {
            outline: none;
            border-color: #1A1A1A;
            background: #FFFFFF;
        }

        #transcriptEditor {
            background: #FAFAFA;
            border: 1px solid #E8E8E8;
            color: #1A1A1A;
        }

        #transcriptEditor:focus {
            outline: none;
            border-color: #1A1A1A;
            background: #FFFFFF;
        }

        #transcriptEditor:empty:before {
            content: attr(placeholder);
            color: #999999;
        }

        .non-ciu-mark {
            background-color: #F5F5F5;
            border-bottom: 2px solid #1A1A1A;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: 500;
        }

        .marking-legend {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: #FAFAFA;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 18px;
            border-radius: 3px;
        }

        .status {
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 20px;
            border: 1px solid;
            font-weight: 400;
            letter-spacing: -0.2px;
        }

        .status.info {
            background: #FAFAFA;
            color: #666666;
            border-color: #E8E8E8;
        }

        .status.success {
            background: #F5F5F5;
            color: #1A1A1A;
            border-color: #1A1A1A;
        }

        .status.error {
            background: #FEF2F2;
            color: #991B1B;
            border-color: #FECACA;
        }

        .status.warning {
            background: #FFFBEB;
            color: #92400E;
            border-color: #FDE68A;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0;
            margin-top: 60px;
            border-top: 1px solid #E8E8E8;
        }

        .result-card {
            background: #FFFFFF;
            border-right: 1px solid #E8E8E8;
            border-bottom: 1px solid #E8E8E8;
            padding: 40px 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .result-card:hover {
            background: #FAFAFA;
        }

        .result-label {
            font-size: 11px;
            color: #999999;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .result-value {
            font-size: 48px;
            font-weight: 300;
            color: #1A1A1A;
            letter-spacing: -2px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #E5E7EB;
            border-top: 2px solid #6366F1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .detail-section {
            background: #FAFAFA;
            border: 1px solid #E8E8E8;
            padding: 40px;
            border-radius: 8px;
            margin-top: 40px;
        }

        .detail-section h3 {
            font-size: 12px;
            color: #999999;
            margin-bottom: 20px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .analysis-text {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 14px;
            color: #666666;
            font-weight: 400;
        }

        .info-box {
            background: #FAFAFA;
            border: 1px solid #E8E8E8;
            padding: 24px;
            margin-bottom: 60px;
            border-radius: 8px;
            font-size: 14px;
            color: #666666;
            font-weight: 400;
            line-height: 1.7;
            letter-spacing: -0.2px;
        }

        .info-box strong {
            color: #1A1A1A;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CIU Analysis Tool</h1>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>Instructions:</strong> You can either (1) record a speech sample and auto-transcribe, or (2) paste/type a transcription directly. Then click "Analyze for CIUs" to calculate measures based on Nicholas & Brookshire (1993) scoring rules.
                <br><br>
                <strong>Note:</strong> This tool provides automated analysis of basic CIU rules. For clinical use, manual verification is recommended for complex cases involving repetitions, false starts, ambiguous pronouns, and context-specific accuracy judgments.
            </div>

            <!-- Step 1: Recording -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">1</span>
                    Record Speech Sample (Optional)
                </div>
                <div class="recording-controls">
                    <button class="btn btn-record" id="recordBtn">
                        <span id="recordIcon">üî¥</span>
                        <span id="recordText">Start Recording</span>
                    </button>
                    <button class="btn btn-stop" id="stopBtn" disabled>
                        <span>‚èπÔ∏è</span>
                        <span>Stop Recording</span>
                    </button>
                    <div class="timer" id="timer">00:00</div>
                </div>
                <div id="audioPlayback" style="margin-top: 15px; display: none;">
                    <audio controls id="audioPlayer" style="width: 100%; max-width: 500px;"></audio>
                </div>
                <div id="recordStatus"></div>
            </div>

            <!-- Step 2: Transcription -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">2</span>
                    Review or Enter Transcription
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #6B7280; margin-bottom: 8px; font-weight: 500;">
                        Sample Duration (optional - for pasted text):
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="manualMinutes" min="0" max="59" placeholder="0" 
                                   style="width: 60px; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px; text-align: center;">
                            <span style="font-size: 13px; color: #6B7280;">min</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="manualSeconds" min="0" max="59" placeholder="0" 
                                   style="width: 60px; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px; text-align: center;">
                            <span style="font-size: 13px; color: #6B7280;">sec</span>
                        </div>
                        <span style="font-size: 12px; color: #9CA3AF; font-style: italic; margin-left: 10px;">
                            Leave blank to estimate based on word count
                        </span>
                    </div>
                </div>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn" id="markNonCIUBtn" style="background: #f59e0b; color: white; padding: 8px 16px; font-size: 14px;">
                        <span>üñçÔ∏è</span>
                        <span>Mark as Non-CIU</span>
                    </button>
                    <button class="btn" id="unmarkBtn" style="background: #6b7280; color: white; padding: 8px 16px; font-size: 14px;">
                        <span>‚Ü©Ô∏è</span>
                        <span>Remove Marking</span>
                    </button>
                    <button class="btn" id="clearAllMarksBtn" style="background: #ef4444; color: white; padding: 8px 16px; font-size: 14px;">
                        <span>üóëÔ∏è</span>
                        <span>Clear All Marks</span>
                    </button>
                    <div style="font-size: 13px; color: #6b7280; padding: 4px 8px; background: #f3f4f6; border-radius: 4px;">
                        <strong>Tip:</strong> Select text and click "Mark as Non-CIU" to highlight words that shouldn't count
                    </div>
                </div>
                <div id="transcriptEditor" contenteditable="true" style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; line-height: 1.6; background: white; overflow-y: auto; max-height: 400px;" placeholder="Type or paste your transcription here, or record audio above to auto-transcribe..."></div>
                <div id="transcriptStatus"></div>
                <div id="markingStatus" style="margin-top: 10px;"></div>
            </div>

            <!-- Step 3: Analysis -->
            <div class="section">
                <div class="section-title">
                    <span class="step-number">3</span>
                    Analyze CIU Measures
                </div>
                <button class="btn btn-analyze" id="analyzeBtn" disabled>
                    <span>üìä</span>
                    <span>Analyze for CIUs</span>
                </button>
                <div id="analyzeStatus"></div>
            </div>

            <!-- Results -->
            <div class="section" id="resultsSection" style="display: none;">
                <div class="section-title">
                    <span class="step-number">‚úì</span>
                    Results
                </div>
                <div class="results-grid" id="resultsGrid"></div>
                <div class="detail-section" id="detailSection" style="display: none;">
                    <h3>Detailed Analysis</h3>
                    <div class="analysis-text" id="detailText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let startTime;
        let timerInterval;
        let recordingDuration = 0;
        let fullTranscript = '';
        let isRecording = false;
        let audioBlob = null;

        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const timer = document.getElementById('timer');
        const transcriptEditor = document.getElementById('transcriptEditor');
        const recordStatus = document.getElementById('recordStatus');
        const transcriptStatus = document.getElementById('transcriptStatus');
        const analyzeStatus = document.getElementById('analyzeStatus');
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const detailSection = document.getElementById('detailSection');
        const detailText = document.getElementById('detailText');
        const audioPlayback = document.getElementById('audioPlayback');
        const audioPlayer = document.getElementById('audioPlayer');
        const markNonCIUBtn = document.getElementById('markNonCIUBtn');
        const unmarkBtn = document.getElementById('unmarkBtn');
        const clearAllMarksBtn = document.getElementById('clearAllMarksBtn');
        const markingStatus = document.getElementById('markingStatus');

        // Enable analyze button when user types/pastes text
        transcriptEditor.addEventListener('input', () => {
            if (transcriptEditor.textContent.trim().length > 0) {
                analyzeBtn.disabled = false;
            } else {
                analyzeBtn.disabled = true;
            }
        });

        // Marking functionality
        markNonCIUBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                showStatus(markingStatus, '‚ö†Ô∏è Please select text to mark as non-CIU', 'warning');
                return;
            }

            const range = selection.getRangeAt(0);
            
            // Check if selection is within the editor
            if (!transcriptEditor.contains(range.commonAncestorContainer)) {
                showStatus(markingStatus, '‚ö†Ô∏è Please select text within the transcription box', 'warning');
                return;
            }

            // Create a span to mark the text
            const span = document.createElement('span');
            span.className = 'non-ciu-mark';
            span.setAttribute('data-non-ciu', 'true');
            
            try {
                range.surroundContents(span);
                selection.removeAllRanges();
                showStatus(markingStatus, '‚úÖ Text marked as non-CIU (will be excluded from CIU count)', 'success');
            } catch (e) {
                // If surroundContents fails (e.g., partial element selection), try a different approach
                const fragment = range.extractContents();
                span.appendChild(fragment);
                range.insertNode(span);
                selection.removeAllRanges();
                showStatus(markingStatus, '‚úÖ Text marked as non-CIU', 'success');
            }
        });

        unmarkBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                showStatus(markingStatus, '‚ö†Ô∏è Please select marked text to remove marking', 'warning');
                return;
            }

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            
            // Find the marked span
            let markedSpan = container.nodeType === Node.ELEMENT_NODE ? container : container.parentElement;
            
            while (markedSpan && !markedSpan.hasAttribute('data-non-ciu')) {
                markedSpan = markedSpan.parentElement;
            }

            if (markedSpan && markedSpan.hasAttribute('data-non-ciu')) {
                const parent = markedSpan.parentNode;
                while (markedSpan.firstChild) {
                    parent.insertBefore(markedSpan.firstChild, markedSpan);
                }
                parent.removeChild(markedSpan);
                parent.normalize(); // Merge adjacent text nodes
                showStatus(markingStatus, '‚úÖ Marking removed', 'success');
            } else {
                showStatus(markingStatus, '‚ö†Ô∏è No marked text found in selection', 'warning');
            }
            
            selection.removeAllRanges();
        });

        clearAllMarksBtn.addEventListener('click', () => {
            const marks = transcriptEditor.querySelectorAll('.non-ciu-mark');
            marks.forEach(mark => {
                const parent = mark.parentNode;
                while (mark.firstChild) {
                    parent.insertBefore(mark.firstChild, mark);
                }
                parent.removeChild(mark);
            });
            transcriptEditor.normalize();
            showStatus(markingStatus, '‚úÖ All markings cleared', 'success');
        });

        // Check for speech recognition support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function showStatus(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        recordBtn.addEventListener('click', async () => {
            try {
                // Get audio stream for recording
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Set up MediaRecorder for audio playback
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayback.style.display = 'block';
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                // Set up Speech Recognition for transcription if available
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';
                    recognition.maxAlternatives = 1;

                    fullTranscript = '';
                    transcriptEditor.textContent = '';
                    
                    recognition.onresult = (event) => {
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcriptPiece = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                fullTranscript += transcriptPiece + ' ';
                            } else {
                                interimTranscript += transcriptPiece;
                            }
                        }
                        
                        transcriptEditor.textContent = fullTranscript + interimTranscript;
                    };

                    recognition.onerror = (event) => {
                        if (event.error === 'not-allowed') {
                            showStatus(transcriptStatus, '‚ùå Microphone access denied. Recording saved, but auto-transcription unavailable.', 'error');
                        } else if (event.error !== 'no-speech' && event.error !== 'aborted') {
                            console.log('Recognition error:', event.error);
                        }
                    };

                    recognition.onend = () => {
                        if (isRecording) {
                            try {
                                recognition.start();
                            } catch (e) {
                                // Recognition already stopped
                            }
                        }
                    };

                    try {
                        recognition.start();
                        showStatus(transcriptStatus, 'üëÇ Auto-transcribing... (Note: May not capture all fillers - you can edit manually)', 'info');
                    } catch (e) {
                        showStatus(transcriptStatus, '‚ö†Ô∏è Auto-transcription unavailable. Please transcribe manually after recording.', 'warning');
                    }
                }

                // Start timer
                isRecording = true;
                startTime = Date.now();
                recordingDuration = 0;
                
                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    recordingDuration = elapsed;
                    timer.textContent = formatTime(elapsed);
                    
                    if (elapsed >= 180) {
                        stopRecording();
                        showStatus(recordStatus, '‚è±Ô∏è Maximum recording time (3 minutes) reached', 'warning');
                    }
                }, 1000);

                recordBtn.disabled = true;
                stopBtn.disabled = false;
                recordBtn.classList.add('recording');
                timer.classList.add('recording');
                document.getElementById('recordIcon').textContent = '‚è∫Ô∏è';
                document.getElementById('recordText').textContent = 'Recording...';
                showStatus(recordStatus, 'üéôÔ∏è Recording in progress... Speak clearly into your microphone.', 'info');

            } catch (error) {
                showStatus(recordStatus, '‚ùå Error accessing microphone: ' + error.message, 'error');
            }
        });

        stopBtn.addEventListener('click', stopRecording);

        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            
            // Stop timer immediately
            clearInterval(timerInterval);
            
            // Stop media recorder
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Stop speech recognition
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Already stopped
                }
            }
            
            // Update UI
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            recordBtn.classList.remove('recording');
            timer.classList.remove('recording');
            document.getElementById('recordIcon').textContent = 'üî¥';
            document.getElementById('recordText').textContent = 'Start Recording';
            showStatus(recordStatus, '‚úÖ Recording complete! You can now play it back below.', 'success');
            
            if (fullTranscript.trim()) {
                transcriptEditor.textContent = fullTranscript.trim();
                analyzeBtn.disabled = false;
                showStatus(transcriptStatus, '‚úÖ Auto-transcription complete. IMPORTANT: Review and edit to add any missing fillers (um, uh, you know, etc.)', 'success');
            } else if (transcriptEditor.textContent.trim()) {
                analyzeBtn.disabled = false;
            } else {
                showStatus(transcriptStatus, '‚ö†Ô∏è No transcription available. Please listen to the recording and transcribe manually, or paste existing text.', 'warning');
            }
        }

        analyzeBtn.addEventListener('click', async () => {
            const transcriptText = transcriptEditor.textContent.trim();
            if (!transcriptText) {
                showStatus(analyzeStatus, '‚ö†Ô∏è Please provide a transcription first.', 'warning');
                return;
            }

            try {
                showStatus(analyzeStatus, '<div class="loading"></div> Analyzing speech sample for CIUs...', 'info');
                analyzeBtn.disabled = true;

                // Get manually marked non-CIU words
                const manuallyMarkedNonCIUs = new Set();
                const marks = transcriptEditor.querySelectorAll('.non-ciu-mark');
                marks.forEach(mark => {
                    const text = mark.textContent.toLowerCase().trim();
                    if (text) {
                        // Split into words in case multiple words were marked together
                        text.split(/\s+/).forEach(word => {
                            const cleanWord = word.replace(/[.,!?;:"']/g, '');
                            if (cleanWord) manuallyMarkedNonCIUs.add(cleanWord);
                        });
                    }
                });

                // Get manual time entry if provided
                const manualMinutes = parseInt(document.getElementById('manualMinutes').value) || 0;
                const manualSeconds = parseInt(document.getElementById('manualSeconds').value) || 0;
                const manualDuration = (manualMinutes * 60) + manualSeconds;
                
                // Use manual duration if provided, otherwise use recording duration
                const duration = manualDuration > 0 ? manualDuration : recordingDuration;

                // Perform analysis
                const results = analyzeTranscript(transcriptText, duration, manuallyMarkedNonCIUs);
                
                displayResults(results);
                showStatus(analyzeStatus, `‚úÖ Analysis complete! ${manuallyMarkedNonCIUs.size > 0 ? `(${manuallyMarkedNonCIUs.size} manually marked words excluded from CIUs)` : ''}`, 'success');

            } catch (error) {
                console.error('Analysis error:', error);
                showStatus(analyzeStatus, '‚ùå Analysis error: ' + error.message, 'error');
                analyzeBtn.disabled = false;
            }
        });

        function analyzeTranscript(text, duration, manuallyMarkedNonCIUs = new Set()) {
            // Clean and tokenize
            const words = text.split(/\s+/).filter(w => w.length > 0);
            
            // Filler words and phrases that count as words but NOT as CIUs
            const fillers = new Set([
                'um', 'uh', 'er', 'ah', 'hmm', 'mm',
                'you know', 'i mean', 'like', 'well', 'okay', 'ok',
                'oh', 'wow', 'gosh', 'gee', 'golly',
                'apparently', 'evidently', 'sort of', 'kind of',
                'i think', 'it looks like', 'of course'
            ]);

            // Words that are NEVER CIUs
            const neverCIU = new Set(['and']);

            // Contractions to split (each counts as 2 words and potentially 2 CIUs)
            const contractions = {
                "don't": ["do", "not"], "won't": ["will", "not"], "can't": ["can", "not"],
                "shouldn't": ["should", "not"], "wouldn't": ["would", "not"], "couldn't": ["could", "not"],
                "isn't": ["is", "not"], "aren't": ["are", "not"], "wasn't": ["was", "not"],
                "weren't": ["were", "not"], "hasn't": ["has", "not"], "haven't": ["have", "not"],
                "hadn't": ["had", "not"], "doesn't": ["does", "not"], "didn't": ["did", "not"],
                "i'm": ["i", "am"], "you're": ["you", "are"], "he's": ["he", "is"],
                "she's": ["she", "is"], "it's": ["it", "is"], "we're": ["we", "are"],
                "they're": ["they", "are"], "i've": ["i", "have"], "you've": ["you", "have"],
                "we've": ["we", "have"], "they've": ["they", "have"], "i'd": ["i", "would"],
                "you'd": ["you", "would"], "he'd": ["he", "would"], "she'd": ["she", "would"],
                "we'd": ["we", "would"], "they'd": ["they", "would"], "i'll": ["i", "will"],
                "you'll": ["you", "will"], "he'll": ["he", "will"], "she'll": ["she", "will"],
                "we'll": ["we", "will"], "they'll": ["they", "will"],
                "gonna": ["going", "to"], "wanna": ["want", "to"], "gotta": ["got", "to"]
            };

            let totalWords = 0;
            let totalCIUs = 0;
            let processedWords = [];
            let manualExclusions = 0;

            for (let word of words) {
                const cleanWord = word.toLowerCase().replace(/[.,!?;:"']/g, '');
                
                // Skip empty or unintelligible markers
                if (!cleanWord || cleanWord === '[unclear]' || cleanWord === '...') continue;

                // Handle contractions
                if (contractions[cleanWord]) {
                    const expanded = contractions[cleanWord];
                    totalWords += 2;
                    processedWords.push(...expanded);
                    // Both parts can be CIUs unless they're excluded
                    for (let part of expanded) {
                        if (manuallyMarkedNonCIUs.has(part)) {
                            manualExclusions++;
                        } else if (!fillers.has(part) && !neverCIU.has(part)) {
                            totalCIUs++;
                        }
                    }
                }
                // Handle hyphenated words (count each part)
                else if (cleanWord.includes('-')) {
                    const parts = cleanWord.split('-');
                    totalWords += parts.length;
                    processedWords.push(...parts);
                    for (let part of parts) {
                        if (manuallyMarkedNonCIUs.has(part)) {
                            manualExclusions++;
                        } else if (!fillers.has(part) && !neverCIU.has(part)) {
                            totalCIUs++;
                        }
                    }
                }
                // Regular word
                else {
                    totalWords++;
                    processedWords.push(cleanWord);
                    
                    // Check if it's a CIU
                    // First check if manually marked as non-CIU
                    if (manuallyMarkedNonCIUs.has(cleanWord)) {
                        manualExclusions++;
                    }
                    // Then exclude fillers and 'and'
                    else if (!fillers.has(cleanWord) && !neverCIU.has(cleanWord)) {
                        totalCIUs++;
                    }
                }
            }

            // Calculate metrics
            const percentCIUs = totalWords > 0 ? ((totalCIUs / totalWords) * 100).toFixed(1) : 0;
            
            let wordsPerMinute, ciusPerMinute;
            if (duration > 0) {
                const minutes = duration / 60;
                wordsPerMinute = (totalWords / minutes).toFixed(1);
                ciusPerMinute = (totalCIUs / minutes).toFixed(1);
            } else {
                // Estimate based on typical speech rate
                const estimatedMinutes = totalWords / 150;
                wordsPerMinute = (estimatedMinutes > 0 ? (totalWords / estimatedMinutes).toFixed(1) : "N/A");
                ciusPerMinute = (estimatedMinutes > 0 ? (totalCIUs / estimatedMinutes).toFixed(1) : "N/A");
            }

            const manualNote = manualExclusions > 0 ? ` ${manualExclusions} words were manually marked as non-CIUs by the clinician.` : '';

            return {
                total_words: totalWords,
                total_cius: totalCIUs,
                percent_cius: parseFloat(percentCIUs),
                words_per_minute: parseFloat(wordsPerMinute) || 0,
                cius_per_minute: parseFloat(ciusPerMinute) || 0,
                word_breakdown: `Counted ${totalWords} total words including contractions (split into 2), hyphenated words (each part counted), filler words (um, uh, you know, etc.), and all intelligible content words.`,
                ciu_breakdown: `Counted ${totalCIUs} CIUs by excluding: filler words (um, uh, you know, like, well, etc.), the word "and", and non-informative interjections.${manualNote} All content words (nouns, verbs, adjectives, adverbs, prepositions, articles) were counted as CIUs. Note: This is a simplified automated analysis. For clinical accuracy, manual review following full Nicholas & Brookshire (1993) rules is recommended, especially for: repetitions, false starts, pronoun references, vague terms, and context-specific accuracy.`
            };
        }

        function displayResults(results) {
            resultsGrid.innerHTML = `
                <div class="result-card">
                    <div class="result-label">Total Words</div>
                    <div class="result-value">${results.total_words}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Correct Information Units</div>
                    <div class="result-value">${results.total_cius}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">% CIUs</div>
                    <div class="result-value">${results.percent_cius}%</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Words/Minute</div>
                    <div class="result-value">${results.words_per_minute}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">CIUs/Minute</div>
                    <div class="result-value">${results.cius_per_minute}</div>
                </div>
            `;

            detailText.innerHTML = `<strong>Word Count:</strong>\n${results.word_breakdown}\n\n<strong>CIU Analysis:</strong>\n${results.ciu_breakdown}`;
            
            resultsSection.style.display = 'block';
            detailSection.style.display = 'block';
            analyzeBtn.disabled = false;
        }
    </script>
</body>
</html>
